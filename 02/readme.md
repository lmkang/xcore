### 02、保护模式  
a、从硬盘中读取loader到内存  
（1）先选择通道，往该通道的sector count寄存器中写入待操作的扇区数；  
（2）往该通道上的三个LBA寄存器写入扇区起始地址的低24位；  
（3）往device寄存器中写入LBA地址的27~24位，并设第6位为1（LBA模式），设第4位为0（master硬盘）；  
（4）往该通道上的command寄存器写入读取命令（0x20）；  
（5）读取该通道上的status寄存器，判断硬盘工作是否完成；  
（6）将硬盘数据读出。  
b、进入保护模式  
（1）打开A20Gate
```
in al, 0x92
or al, 0x02
out 0x92, al
```
（2）加载GDT
```
lgdt [GDT_PTR]
```
（3）清空流水线
```
jmp dword SELECTOR_CODE:p_mode_start
```
c、获取物理内存容量  
&emsp;&emsp;在Linux上有多种方法获取物理内存容量，如果一种方法失败了，就会用其他方法。我们可以学习Linux获取物理内存容量的方法。Linux本质上是通过调用BIOS中断0x15获取物理内存容量的，分别是0x15的3个子功能，子功能号要存放到寄存器EAX或AX中，按照内存信息的返回情况分别如下：
```
EAX=0xe820：遍历主机上的全部内存
AX=0xe801：分别检测低15MB和16MB~4GB的内存，最大支持4GB
AH=0x88：最多检测出64MB的内存，实际内存超过此容量也按照16MB返回
```
&emsp;&emsp;注意：BIOS中断是实模式下的功能，只能在进入保护模式前调用。

d、分页模式  
&emsp;&emsp;在分段模式下，“段基址：段内偏移”和物理地址是一一对应的，如果运行的进程比较多，每个进程所占用的内存又不一样，那个进程之间必然会造成很多的内存碎片无法被利用到。分页机制的思想是：通过映射，可以使连续的线性地址与任意物理内存相关联，逻辑上连续的线性地址其对应的物理地址可以不连续。分页机制的作用有两点：将线性地址转换成物理地址；用大小相等的页（4KB）代替大小不等的段。  
&emsp;&emsp;无论是几级页表，标准页的大小都是4KB，所以4GB线性地址空间最多有1M个标准页。一级页表是将这1MB个标准页放置到一张页表中，二级页表是将这1M个标准页平均放置到1K个页表中。每个页表中包含1K个页表项，页表项是4字节大小，页表包含1K个页表项，故页表大小为4KB，这恰好是一个标准页的大小。  
&emsp;&emsp;对于二级页表来说，专门有个页目录表来存储这个页表。页目录表有1024个4字节大小的页目录项（Page Directory Entry，PDE），页目录项中存的就是页表的物理地址，一个页表有1024个4字节大小的页表项（Page Table Entry，PTE），页表项中存放的是物理页的地址。  
&emsp;&emsp;二级页表转换步骤：  
（1）用虚拟地址的高10位乘以4，作为页目录表内的偏移地址，加上页目录表的物理地址，所得的和便是页目录项的物理地址。读取该页目录项，从而获得页表的物理地址；  
（2）用虚拟地址的中间10位乘以4，作为页表的偏移地址，加上第（1）步的页表的物理地址，所得的和便是页表项的物理地址。读取该页表项，从而获得物理页的地址；  
（3）用虚拟地址的低12位加上第（2）步的物理页地址，所得的和便是最终转换的物理地址。  
&emsp;&emsp;启用分页机制步骤：  
（1）准备好页目录表和页表；  
（2）将页表地址写入控制寄存器CR3；  
（3）将寄存器CR0的PG位设为1。
